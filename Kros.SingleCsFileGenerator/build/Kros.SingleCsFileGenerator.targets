<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Kros.SingleCsFileGenerator.MergeCSharpFilesTask"
             AssemblyFile="$(MSBuildThisFileDirectory)net8.0\Kros.SingleCsFileGenerator.dll" />

  <Target Name="ProduceSingleCSharpFile"
          AfterTargets="Compile"
          Condition="'$(ProduceSingleCSharpFile)' == 'true'">

    <!-- Determine the SDK type (order matters - more specific SDKs first, then check if empty) -->
    <PropertyGroup>
      <_DetectedSdk Condition="'$(UsingMicrosoftNETSdkBlazorWebAssembly)' == 'true'">Microsoft.NET.Sdk.BlazorWebAssembly</_DetectedSdk>
      <_DetectedSdk Condition="'$(_DetectedSdk)' == '' AND '$(UsingMicrosoftNETSdkWorker)' == 'true'">Microsoft.NET.Sdk.Worker</_DetectedSdk>
      <_DetectedSdk Condition="'$(_DetectedSdk)' == '' AND '$(UsingMicrosoftNETSdkWeb)' == 'true'">Microsoft.NET.Sdk.Web</_DetectedSdk>
      <_DetectedSdk Condition="'$(_DetectedSdk)' == '' AND '$(UsingMicrosoftNETSdkRazor)' == 'true'">Microsoft.NET.Sdk.Razor</_DetectedSdk>
      <_DetectedSdk Condition="'$(_DetectedSdk)' == ''">Microsoft.NET.Sdk</_DetectedSdk>
    </PropertyGroup>

    <ItemGroup>
      <!-- Exclude auto-generated files from obj folder -->
      <SingleCsFileSources Include="@(Compile)" 
                           Condition="!$([System.String]::new('%(FullPath)').Contains('obj'))" />
    </ItemGroup>

    <MergeCSharpFilesTask
        Sources="@(SingleCsFileSources)"
        OutputFile="$(SingleCSharpOutputFile)"
        ProjectSdk="$(_DetectedSdk)"
        PackageReferences="@(PackageReference)"
        RootNamespace="$(RootNamespace)" />
  </Target>
</Project>
